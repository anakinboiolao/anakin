<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Preços (Salvando no GitHub)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .price-input { min-width: 80px; max-width: 100px; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 40;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: white; border-radius: 0.5rem;
            padding: 1.5rem; max-height: 90vh; overflow-y: auto;
            min-width: 500px; max-width: 95%;
        }
        .hidden { display: none !important; }
        .tab-button.active { background-color: white; border-color: #e5e7eb; font-weight: 600; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- Video Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-50 bg-black flex items-center justify-center">
        <video id="intro-video" autoplay muted playsinline class="w-full h-full object-cover">
            <source src="abertura.mp4" type="video/mp4">
            Seu navegador não suporta o vídeo de abertura.
        </video>
        <button id="skip-intro-btn" class="absolute bottom-5 right-5 px-4 py-2 bg-white bg-opacity-20 text-white rounded hover:bg-opacity-40 transition-colors backdrop-blur-sm">Pular Abertura</button>
    </div>

    <!-- GitHub Settings Modal (initially hidden) -->
    <div id="github-settings-modal" class="modal-backdrop hidden">
        <div class="modal-content w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Configuração do GitHub</h2>
            <p class="text-sm text-stone-600 mb-4">Para salvar seus dados no seu repositório, a aplicação precisa de um Token de Acesso Pessoal (PAT). Siga as instruções abaixo.</p>
            <div class="space-y-4">
                <div><label for="github-user" class="block text-sm font-medium text-stone-700">Seu nome de usuário no GitHub</label><input type="text" id="github-user" class="mt-1 block w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm"></div>
                <div><label for="github-repo" class="block text-sm font-medium text-stone-700">Nome do Repositório</label><input type="text" id="github-repo" class="mt-1 block w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm"></div>
                <div><label for="github-token" class="block text-sm font-medium text-stone-700">Token de Acesso Pessoal (PAT)</label><input type="password" id="github-token" class="mt-1 block w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm"></div>
            </div>
            <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                <h4 class="font-semibold text-yellow-800">Como gerar seu Token:</h4>
                <ol class="list-decimal list-inside text-sm text-yellow-700 mt-2">
                    <li>Vá para <a href="https://github.com/settings/tokens/new" target="_blank" class="underline font-medium">github.com/settings/tokens/new</a>.</li>
                    <li>Dê um nome para o token (ex: "CalculadoraCarnes").</li>
                    <li>Selecione a expiração (recomendado 30 ou 60 dias).</li>
                    <li>Na seção "Repository access", selecione "Only select repositories" e escolha o repositório desta calculadora.</li>
                    <li>Clique em "Repository permissions", abra, e marque a permissão **"Contents"** como **Read and write**.</li>
                    <li>Clique em "Generate token" e copie o token gerado. Cole-o no campo acima.</li>
                </ol>
            </div>
            <div class="flex justify-end mt-6"><button id="connect-github-btn" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Conectar e Carregar Dados</button></div>
        </div>
    </div>

    <!-- App Container (initially hidden) -->
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-10 gap-3">
            <h1 class="text-xl sm:text-2xl font-bold text-stone-900">Calculadora de Preços</h1>
            <div class="flex items-center space-x-2">
                 <div id="status-indicator" class="text-sm text-gray-500 mr-4"></div>
                <button id="manage-pesos-btn" class="px-3 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300 text-sm">Gerenciar Pesos</button>
                <button id="save-button" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 shadow-sm">Salvar no GitHub</button>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <div id="sheets-container" class="space-y-8">
                <!-- As fichas de cálculo serão renderizadas aqui -->
            </div>
            <div class="mt-8 text-center">
                <button id="add-sheet-btn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 shadow-lg transition-transform hover:scale-105">
                    + Adicionar Nova Ficha de Cálculo
                </button>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-backdrop hidden">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script type="module">
        // --- GitHub API Logic ---
        const GITHUB_API_URL = 'https://api.github.com';
        const DATA_FILE_PATH = 'dados.json';
        let githubConfig = { user: '', repo: '', token: '', fileSha: null };
        const statusIndicator = document.getElementById('status-indicator');
        const setStatus = (message, isError = false) => {
            statusIndicator.textContent = message;
            statusIndicator.className = isError ? 'text-sm text-red-500' : 'text-sm text-gray-500';
        };
        async function loadDataFromGitHub() { /* ... unchanged ... */ }
        async function saveDataToGitHub() { /* ... unchanged ... */ }
        
        // --- Default Data Structures ---
        const DEFAULT_PESOS_DATABASE = { "CABEÇA COMPLETA COM PA": 2.850, "CABEÇA SEM PAPADA": 1.700, "PÉ COM JOELHO": 2.550, "PÉ": 1.050, "JOELHO": 1.500, "ORELHA": 0.250, "ORELHA COM PAPADA": 1.150, "PAPADA": 0.900, "PÁ COM OSSO E TOUCINHO": 12.100, "PÁ SEM OSSO": 8.200, "CARRÉ COM OSSO E TOUCINHO": 6.550, "TOUCINHO DO CARRÉ": 0.850, "OSSO DO CARRÉ": 1.450, "CARRÉ SEM OSSO LOMBO": 3.400, "PERNIL COM OSSO E TOUCINHO": 12.600, "TOUCINHO DO PERNIL": 1.050, "PERNIL SEM OSSO": 10.050, "COSTELINHA SUINA COM TC": 7.400, "TOUCINHO DA COSTELINHA": 1.450, "COSTELINHA SEM TOUCINHO": 6.000, "BARRIGUINHA": 2.550, "PERNIL SUJO": 11.185, "PÁ SUJA": 10.275, "CARRÉ SUJO": 7.3, "LOMBO LIMPO": 3.55 };
        const createDefaultSheet = (title) => ({
            id: `sheet_${Date.now()}_${Math.random()}`,
            title: title,
            cost_inputs: { peso_materia_prima: "100,000", preco_unit_materia_prima: "10,00", st_percent: "6,05", fator_rendimento: "92,00" },
            items: [
                { id: `item_${Date.now()}`, desc: 'Exemplo de Corte 1', cod: '001', linkedPesoKeys: [], prUnit: 0 },
                { id: `item_${Date.now()+1}`, desc: 'Exemplo de Corte 2', cod: '002', linkedPesoKeys: [], prUnit: 0 }
            ]
        });

        let appData = {
            pesos_carnes: {},
            sheets: []
        };
        
        // --- Utility Functions ---
        const formatCurrency = (value) => `R$ ${Number(value).toFixed(2).replace('.', ',')}`;
        const formatNumber = (value) => Number(value).toFixed(3).replace('.', ',');
        const parseFloatBR = (str) => parseFloat(String(str).replace(/\./g, '').replace(',', '.')) || 0;
        
        // --- Modal Logic ---
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const showModal = (content) => { modalContent.innerHTML = content; modalContainer.classList.remove('hidden'); };
        const hideModal = () => modalContainer.classList.add('hidden');
        modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer) hideModal(); });

        // --- Main Render Function ---
        const render = () => {
            const sheetsContainer = document.getElementById('sheets-container');
            sheetsContainer.innerHTML = '';
            appData.sheets.forEach(sheet => {
                sheetsContainer.appendChild(buildSheetElement(sheet));
            });
        };

        // --- Element Builders ---
        function buildSheetElement(sheet) {
            const sheetContainer = document.createElement('section');
            sheetContainer.className = 'bg-white p-4 sm:p-6 rounded-lg shadow-lg space-y-4';
            sheetContainer.dataset.sheetId = sheet.id;

            const totalCustoLiquido = calculateSheetCost(sheet);
            
            // Header
            sheetContainer.innerHTML = `
                <div class="flex justify-between items-center border-b pb-3">
                    <h2 class="text-xl sm:text-2xl font-bold text-indigo-700">${sheet.title}</h2>
                    <div>
                        <button class="edit-sheet-btn px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">Editar</button>
                        <button class="delete-sheet-btn px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">Excluir</button>
                    </div>
                </div>
            `;
            
            // Cost Calculator
            const costCalculator = document.createElement('div');
            costCalculator.innerHTML = `
                <h3 class="text-lg font-semibold mb-2">Cálculo de Custo da Ficha</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 cost-calculator-inputs">
                    ${buildCostInput('peso_materia_prima', 'Peso Matéria-Prima (Kg)', sheet.cost_inputs.peso_materia_prima)}
                    ${buildCostInput('preco_unit_materia_prima', 'Preço Unitário (R$)', sheet.cost_inputs.preco_unit_materia_prima)}
                    ${buildCostInput('st_percent', 'ST (%)', sheet.cost_inputs.st_percent)}
                    ${buildCostInput('fator_rendimento', 'Fator Rendimento (%)', sheet.cost_inputs.fator_rendimento)}
                </div>
                <div class="flex justify-end items-center text-lg font-bold mt-4 pt-4 border-t">
                    <span class="text-stone-600 mr-4">TOTAL LÍQUIDO CUSTO:</span>
                    <span class="text-indigo-700">${formatCurrency(totalCustoLiquido)}</span>
                </div>
            `;
            sheetContainer.appendChild(costCalculator);

            // Table
            const tableContainer = document.createElement('div');
            tableContainer.className = "overflow-x-auto";
            tableContainer.innerHTML = buildItemsTable(sheet, totalCustoLiquido);
            sheetContainer.appendChild(tableContainer);

            return sheetContainer;
        }

        function buildCostInput(id, label, value) {
            return `<div>
                        <label for="${id}" class="block text-sm font-medium text-stone-700">${label}</label>
                        <input type="text" data-key="${id}" value="${value}" class="cost-input mt-1 block w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                    </div>`;
        }
        
        function buildItemsTable(sheet, totalCustoLiquido) {
            let tableTotalVenda = 0;
            const tableRowsHTML = sheet.items.map(item => {
                const peso = (item.linkedPesoKeys || []).reduce((sum, key) => sum + (appData.pesos_carnes[key] || 0), 0);
                const totalVendaItem = peso * item.prUnit;
                tableTotalVenda += totalVendaItem;
                return `
                    <tr class="bg-white border-b hover:bg-stone-50">
                        <td class="px-4 py-3 font-medium text-stone-900 whitespace-nowrap">${item.desc}</td>
                        <td class="px-4 py-3 text-right">
                            <button data-item-id="${item.id}" class="link-peso-btn px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">${formatNumber(peso)}</button>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <input type="text" value="${String(item.prUnit.toFixed(2)).replace('.',',')}" data-item-id="${item.id}" class="item-price-input price-input text-right bg-stone-50 border border-stone-300 rounded-md px-2 py-1 shadow-sm">
                        </td>
                        <td class="px-4 py-3 text-right font-semibold">${formatCurrency(totalVendaItem)}</td>
                    </tr>`;
            }).join('');

            const lucroPercent = totalCustoLiquido > 0 ? ((tableTotalVenda - totalCustoLiquido) / totalCustoLiquido) * 100 : 0;
            const profitColor = lucroPercent >= 0 ? 'text-green-600' : 'text-red-600';

            return `
                <div class="flex justify-between items-center my-4">
                    <h3 class="text-lg font-semibold">Itens da Ficha</h3>
                    <p class="font-bold text-lg ${profitColor}">LUCRO = ${lucroPercent.toFixed(2).replace('.',',')}%</p>
                </div>
                <table class="w-full text-sm text-left text-stone-500">
                    <thead class="text-xs text-stone-700 uppercase bg-stone-50">
                        <tr>
                            <th scope="col" class="px-4 py-3">Descrição</th>
                            <th scope="col" class="px-4 py-3 text-right">Peso</th>
                            <th scope="col" class="px-4 py-3 text-right">Pr. Unit.</th>
                            <th scope="col" class="px-4 py-3 text-right">Preço Total</th>
                        </tr>
                    </thead>
                    <tbody>${tableRowsHTML}</tbody>
                    <tfoot>
                        <tr class="font-semibold text-stone-900 bg-stone-50">
                            <th scope="row" colspan="3" class="px-4 py-3 text-base text-right">Total Bruto de Venda</th>
                            <td class="px-4 py-3 text-base text-right">${formatCurrency(tableTotalVenda)}</td>
                        </tr>
                    </tfoot>
                </table>`;
        }
        
        // --- Calculation Logic ---
        const calculateSheetCost = (sheet) => {
            const { peso_materia_prima, preco_unit_materia_prima, st_percent, fator_rendimento } = sheet.cost_inputs;
            const peso = parseFloatBR(peso_materia_prima);
            const pr_unit = parseFloatBR(preco_unit_materia_prima);
            const st = parseFloatBR(st_percent);
            const fat = parseFloatBR(fator_rendimento);
            const total_materia_prima = peso * pr_unit;
            const st_total = total_materia_prima * (st / 100.0);
            const custo_com_st = total_materia_prima + st_total;
            return (fat !== 0) ? (custo_com_st / fat) * 100.0 : 0;
        };

        // --- Management Modals & Logic ---
        const openPesoManager = () => { /* ... unchanged ... */ };
        const openLinkWeightsModal = (sheet, itemId) => { /* ... adapted for new structure ... */ };

        // --- Initial Load & Event Listeners ---
        async function initializeApp() {
            // Splash Screen Logic
            const splashScreen = document.getElementById('splash-screen');
            const githubSettingsModal = document.getElementById('github-settings-modal');
            const introVideo = document.getElementById('intro-video');
            const skipIntroBtn = document.getElementById('skip-intro-btn');

            function enterApp() {
                if (!splashScreen.classList.contains('hidden')) {
                    splashScreen.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => {
                        splashScreen.classList.add('hidden');
                        githubSettingsModal.classList.remove('hidden');
                    }, 500);
                }
            }

            introVideo.addEventListener('ended', enterApp);
            skipIntroBtn.addEventListener('click', enterApp);
            introVideo.addEventListener('error', () => { enterApp(); });
            
            // GitHub Connection Logic
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                githubConfig = JSON.parse(savedConfig);
                document.getElementById('github-user').value = githubConfig.user;
                document.getElementById('github-repo').value = githubConfig.repo;
                document.getElementById('github-token').value = githubConfig.token;
            }

            document.getElementById('connect-github-btn').addEventListener('click', async () => {
                githubConfig.user = document.getElementById('github-user').value.trim();
                githubConfig.repo = document.getElementById('github-repo').value.trim();
                githubConfig.token = document.getElementById('github-token').value.trim();
                if (!githubConfig.user || !githubConfig.repo || !githubConfig.token) {
                    alert('Por favor, preencha todos os campos de configuração.');
                    return;
                }
                localStorage.setItem('githubConfig', JSON.stringify(githubConfig));

                const loadedData = await loadDataFromGitHub();
                if (loadedData && loadedData.sheets) {
                    appData = loadedData;
                } else {
                    // Start with default data if none on GitHub or format is old
                    appData.pesos_carnes = { ...DEFAULT_PESOS_DATABASE };
                    appData.sheets = [createDefaultSheet("Exemplo Ficha Suína")];
                }
                
                githubSettingsModal.classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                render();
            });
            
            // Main App Event Listeners
            document.getElementById('save-button').addEventListener('click', saveDataToGitHub);
            document.getElementById('manage-pesos-btn').addEventListener('click', openPesoManager);
            document.getElementById('add-sheet-btn').addEventListener('click', () => {
                const newTitle = prompt("Digite o nome da nova ficha:", "Nova Ficha");
                if (newTitle) {
                    appData.sheets.push(createDefaultSheet(newTitle));
                    render();
                }
            });

            document.body.addEventListener('change', e => {
                const sheetDiv = e.target.closest('[data-sheet-id]');
                if (!sheetDiv) return;
                const sheetId = sheetDiv.dataset.sheetId;
                const sheet = appData.sheets.find(s => s.id === sheetId);
                if (!sheet) return;

                if (e.target.classList.contains('cost-input')) {
                    sheet.cost_inputs[e.target.dataset.key] = e.target.value;
                    render();
                }
                if (e.target.classList.contains('item-price-input')) {
                    const itemId = e.target.dataset.itemId;
                    const item = sheet.items.find(i => i.id === itemId);
                    if(item) {
                        item.prUnit = parseFloatBR(e.target.value);
                        render();
                    }
                }
            });

            // Placeholder for unchanged functions
            async function loadDataFromGitHub() { setStatus('Carregando dados do GitHub...'); const { user, repo, token } = githubConfig; try { const response = await fetch(`${GITHUB_API_URL}/repos/${user}/${repo}/contents/${DATA_FILE_PATH}`, { headers: { 'Authorization': `token ${token}` } }); if (response.status === 404) { setStatus('Arquivo de dados não encontrado. Usando dados padrão.'); return null; } if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`); const data = await response.json(); githubConfig.fileSha = data.sha; setStatus('Dados carregados com sucesso!'); return JSON.parse(atob(data.content)); } catch (error) { console.error('Falha ao carregar dados do GitHub:', error); setStatus(`Erro ao carregar: ${error.message}`, true); return null; } }
            async function saveDataToGitHub() { setStatus('Salvando no GitHub...'); const { user, repo, token, fileSha } = githubConfig; const content = btoa(JSON.stringify(appData, null, 2)); const body = { message: `Atualização de dados da calculadora - ${new Date().toISOString()}`, content: content, sha: fileSha }; try { const response = await fetch(`${GITHUB_API_URL}/repos/${user}/${repo}/contents/${DATA_FILE_PATH}`, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`); const result = await response.json(); githubConfig.fileSha = result.content.sha; setStatus('Salvo com sucesso!'); alert('Dados salvos com sucesso no seu repositório do GitHub!'); } catch (error) { console.error('Falha ao salvar no GitHub:', error); setStatus(`Erro ao salvar: ${error.message}`, true); alert(`Erro ao salvar no GitHub: ${error.message}`); } }
            const openPesoManager = () => { const pesoRows = Object.entries(appData.pesos_carnes).map(([key, value]) => `<div class="grid grid-cols-3 gap-2 items-center mb-2 peso-row"><input class="col-span-2 px-2 py-1 border rounded" data-original-key="${key}" value="${key}"><input type="text" class="px-2 py-1 border rounded text-right" value="${String(value).replace('.',',')}"></div>`).join(''); const content = `<h2 class="text-xl font-bold mb-4">Gerenciar Pesos (Balanço)</h2><div id="peso-list">${pesoRows}</div><div class="flex justify-between mt-4"><button id="add-peso-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Adicionar Peso</button><div><button onclick="document.getElementById('modal-container').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 mr-2">Cancelar</button><button id="save-pesos-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button></div></div>`; showModal(content); };
        }

        initializeApp();
    </script>
</body>
</html>
